<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <!--
        Customize this policy to fit your own app's needs. For more guidance, see:
            https://github.com/apache/cordova-plugin-whitelist/blob/master/README.md#content-security-policy
        Some notes:
            * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
            * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
            * Disables use of inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
                * Enable inline JS: add 'unsafe-inline' to default-src
        -->

        <meta name="format-detection" content="telephone=no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi">

        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css">


        <title>Login</title>
        <link href="nativeDroid2/css/nativedroid2.color.blue.css" rel="stylesheet" type="text/css"/>
        <link href="nativeDroid2/vendor/waves/waves.min.css" rel="stylesheet" type="text/css">
        <link href="nativeDroid2/css/nativedroid2.css" rel="stylesheet" type="text/css">
        <link href="nativeDroid2/vendor/wow/animate.css" rel="stylesheet" type="text/css"/>
        <link href="css/bootstrap.css" rel="stylesheet" type="text/css"/>
        <link href="css/native.css" rel="stylesheet" type="text/css"/>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

        <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
        <script src="nativeDroid2/vendor/waves/waves.min.js" type="text/javascript"></script>
        <script src="nativeDroid2/js/nativedroid2.js" type="text/javascript"></script>
        <script src="nativeDroid2/nd2settings.js" type="text/javascript"></script>
        <script src="nativeDroid2/vendor/wow/wow.min.js" type="text/javascript"></script>
        <script>


        </script>
        <style>
            /**[data-role=header]{top:0; position:fixed !important; bottom: auto !important; width:100%;}  
             **/
            [data-role=footer]{bottom:0; position:fixed !important; top: auto !important; width:100%;}

            .form-input{
                border-width : 1px;
                border-color: #666;
                border-radius: 2px;
                background: #fff;
            }

        </style>

    <body>

        <div data-role="page" id="index"   class="nd2-no-menu-swipe " data-wow-delay='0.01s' style='background:  #fff'>
            <nd2-include data-src="header.html"></nd2-include>

            <div id="loading-overlay"></div>

            <div style="position:fixed; z-index:200; width:100%"  class="clr-bg-white p-1 " >
                <h4 class='clr-black p-1'  > Enter Crime Information </h4>
                <hr class="clr-orange clr-bg-white bg-warning">
            </div>

            <div   id='main'  class="ui-content   " data-inset="false"  style='padding-top:80px;  '>


                <div class='row  '>
                    <div class='col-sm-11 col-md-11 col-lg-11 col-xl-11 col-xs-11 mx-auto wow fadeInLeftBig'>

                        <form id='rep_form' class="" >
                            <div class="form-group">
                                <label  class="clr-white text-black">Subject</label>
                                <input type="text" name="sub" id="c_subject" value="" data-role="none" class='form-input' required="" maxlength="15" placeholder="eg: Murder, Robbery" /> 
                                <br>
                            </div>                    
                            <div class="form-group">
                                <label  class="">Description (200 words)</label>
                                <TextArea name="description" id="name"  data-role="none" class='form-input' required='' maxlength="200" style="height:100px"></textarea> 
                                       <br>
                                   </div>
                                    <div class="form-group">
                                       <label  class="">Location</label>
                                       <TextArea name="location" id="phone" data-role="none" class=' form-input' required=''  maxlength="11" style="height:70px" ></TextArea>
                                       <br>
                                   </div>
                                   <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                                         <label  class="">Upload Evidence</label>
                                            <a href='#file_menu' data-rel='popup' class="btn ui-shadow    btn-warning ui-btn waves-button waves-effect" style="width:150px; height:150px"> 
                                                   
                                                <div  class='ui-corner-all  ' style="width:40px; height:60px" >
                                                
                                                    <center class=' p-2 ui-btn-fab ui-btn ui-btn-raised clr-bg-orange bg-warning text-white' style="z-index:1000; position :relative;  " >
                                                        <i class="zmdi zmdi-upload center-sm" ></i> 
                                                    </center>
                                          
                                        
                                           
                                           </div>
                                                       <img style='height:100%; width:100%; position: absolute; top:0px; left: 0px' id='myImage'   />
                                      </a>
                                            <div data-role='popup' data-position-to='origin' data-history='false' class='ui-shadow ' id='file_menu'>
                                                <ul data-role='listview'>
                                                    <li> <a onclick='cameraTakePicture()'> From Camera </a> </li>
                                                    <li> <a onclick='cameraGetPicture()'> From File </a></li>
                                                </ul>
                                            </div>
                                        
                             
                                        </div>
                                       <div class='col-md-6'>
                                              <button  id='reg_btn' data-role='button' class='ui-btn clr-btn-orange mt-3'>Send Report </button>
                                       </div>
                                    </div>
                                   </div>
                               </form>
       
                            
                           </div>
       
                       </div>
                     
                               
                       
                               
       
                      
       
       </div>

            <nd2-include data-src="footer.html" ></nd2-include> 
        </div>


        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script src="plug.js" type="text/javascript"></script>
        <script>
                                                        $("#title").text("Report Crime");
                                                        var imgPath = null;


                                                        function cameraTakePicture() {

                                                            navigator.camera.getPicture(onSuccess, onFail, {
                                                                quality: 50,
                                                                destinationType: Camera.DestinationType.FILE_URI
                                                            });
                                                            function onSuccess(imageData) {
                                                                var image = document.getElementById('myImage');
                                                                image.src = imageData;
                                                                imgPath = imageData;
                                                            }

                                                            function onFail(message) {

                                                            }
                                                        }

                                                        function cameraGetPicture() {

                                                            navigator.camera.getPicture(onSuccess, onFail, {
                                                                quality: 100,
                                                                destinationType: Camera.DestinationType.FILE_URI,
                                                                sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
                                                                encodingType: Camera.EncodingType.JPEG
                                                            });
                                                            function onSuccess(imageData) {
                                                                var image = document.getElementById('myImage');
                                                                image.src = imageData;
                                                                console.log(imageData);
                                                                imgPath = imageData;

                                                            }

                                                            function onFail(message) {

                                                            }
                                                        }


                                                        $(document).ready(function () {




                                                            $("#rep_form").submit((e) => {
                                                                e.preventDefault();

                                                                var form = new FormData(document.getElementById('rep_form'));
                                                                form.append("username", window.localStorage.getItem('id'))

                                                                $.ajax("https://crime-app.000webhostapp.com/report/",
                                                                        {
                                                                            data: form,
                                                                            processData: false,
                                                                            cache: false,
                                                                            timeout:5000,
                                                                            beforeSend: function () {
                                                                             
                                                                                Spinner('show');
                                                                                $("#loading-overlay").show();
                                                                                
                                                                            },

                                                                            contentType: false,
                                                                            method: 'post',
                                                                            success: function (data, status, xhr) {
                                                                                console.log(data);
                                                                                if (data != 0) {
                                                                                    console.log(imgPath)
                                                                                    if (imgPath !== null) {

                                                                                        uploadEvidence(data)
                                                                                    } else {


                                                                                        toast("Report Sent With no Evidence")
                                                                                        var message = "I reported a crime i witnessed without evidence. Please visit https://crime-app.000webhostapp.com/crime_scene/?id=" + btoa(data);
                                                                                        sendReportSMS(message);
                                                                                        /// $.mobile.changePage('home.html', {dataUrl: "home.html?paremeter=123", data: {'paremeter': '123'}, reloadPage: true, changeHash: true});
                                                                                    }
                                                                                } else {
                                                                                    toast("Something went wrong");
                                                                                      Spinner('hide');
                                                                                $("#loading-overlay").hide();
                                                                                }
                                                                            },
                                                                            error: function (jqXhr, textStatus, errorMessage) { // error callback 
                                                                                 var response = (i) => {
                                                                                if (i == 1) {
                                                                              $("#rep_form").submit();
                                                                                } else {
                                                                                    navigator.app.exitApp();
                                                                                }
                                                                            }
                                                                            app.showNetworkDialog(response);
                                                                            }
                                                                        });
                                                            })


                                                            var uploadEvidence = function (id) {

                                                                var options = new FileUploadOptions();
                                                                options.fileKey = "evidence";
                                                                options.fileName = imgPath.substr(imgPath.lastIndexOf('/') + 1);
                                                                options.mimeType = "image/jpeg";
                                                                options.chunkedMode = false;
                                                                options.httpMethod = "POST";
                                                                var params = new Object();
                                                                params.id = id

                                                                options.params = params;
                                                                var ft = new FileTransfer();
                                                                ft.upload(imgPath, "https://crime-app.000webhostapp.com/report/",
                                                                        function (result) {

                                                                            if (result.response == 1) {
                                                                                toast("Report sent successfully");
                                                                                var message = "I reported a crime i witnessed with evidence. Please visit https://crime-app.000webhostapp.com/crime_scene/?id=" + btoa(id);
                                                                                sendReportSMS(message)
                                                                            }
                                                                            console.log(JSON.stringify(result));

                                                                        },
                                                                        function (error) {
                                                                            var response = (i) => {
                                                                                if (i == 1) {
                                                                               uploadEvidence(id)
                                                                                } else {
                                                                                    navigator.app.exitApp();
                                                                                }
                                                                            }
                                                                            app.showNetworkDialog(response);
                                                                            console.log(JSON.stringify(error));
                                                                        }, options);
                                                            }
                                                        })

        </script>
        <script>
            function sendReportSMS(message) {
              
            
                sms.send("08061555138", message, {android: {intent: ''}}, () => {
                    Spinner("hide");
                    $("#loading-overlay").hide();

                    $('#rep_form').trigger("reset");

                    document.location = 'home.html';
                }, (e) => {
                    toast(e);
                })
            }






            function toast(message) {
                new $.nd2Toast({// The 'new' keyword is important, otherwise you would overwrite the current toast instance
                    message: message, // Required

                    ttl: 8000 // optional, time-to-live in ms (default: 3000)
                });
            }


            //  .on("click", ".hide-page-loading-msg", function () {
            //  $.mobile.loading("hide");
            // });

        </script>


    </body>
</html>
